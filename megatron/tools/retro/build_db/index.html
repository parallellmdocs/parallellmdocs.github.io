
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="中文翻译文档集合">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../sft/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Retro 数据库构建 - Unified Docs (CN)</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="Unified Docs (CN)" class="md-header__button md-logo" aria-label="Unified Docs (CN)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Unified Docs (CN)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Retro 数据库构建
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Unified Docs (CN)" class="md-nav__button md-logo" aria-label="Unified Docs (CN)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Unified Docs (CN)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Megatron
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Megatron
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概览
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    快速入门
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            快速入门
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/QuickStart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速开始
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/datasets/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数据集管线
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/llama_mistral/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Llama/Mistral 指南
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    核心能力
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            核心能力
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/MSC_Integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MSC 集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/README_STRAGGLER/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Straggler 检测
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/transformer/moe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MoE 架构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/optimizer/cpu_offloading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    优化器 CPU Offload
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/models/mimo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MIMO 模型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/distributed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分布式 FSDP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../megatron/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    核心概览
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API 指南
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            API 指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    导航
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/transformer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformer 主体
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/tensor_parallel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    张量并行
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/pipeline_parallel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    流水线并行
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/context_parallel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Context Parallel
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/moe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MoE 系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/multi_latent_attention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Latent Attention
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/multi_token_prediction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    多 Token 预测
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/dist_optimizer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分布式优化器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/custom_fsdp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义 FSDP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/dist_checkpointing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    检查点策略
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/tokenizers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分词体系
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5" checked>
        
          
          <label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    示例与工具
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_5">
            <span class="md-nav__icon md-icon"></span>
            示例与工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/user-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    示例导航
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/export/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    模型导出
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    推理实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/multimodal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    多模态示例
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Retro 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Retro 数据库构建
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Retro 微调
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_6" >
        
          
          <label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    进一步阅读
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_6">
            <span class="md-nav__icon md-icon"></span>
            进一步阅读
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/models.bert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 参考：BERT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/models.gpt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 参考：GPT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/models.t5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 参考：T5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/optimizer_param_scheduler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    优化器调度
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/optimizer_cpu_offload/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CPU Offload 参考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/source/api-guide/distributed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义分布式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    TransformerEngine
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            TransformerEngine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概览
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安装指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    调试工具
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            调试工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    目录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/1_getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/2_config_file_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    配置结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/3_api_debug_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    初始化 API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/3_api_features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    功能列表
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/3_api_te_calls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inspect API 调用
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 索引
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/debug/4_distributed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分布式调试
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API 参考
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            API 参考
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/api/common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    通用配方
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/api/framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    框架专属 API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/api/pytorch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PyTorch API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformerengine/docs/api/jax/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JAX API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<p>本目录包含用于构建 Retro 检索库与预训练邻居的工具集合。整个预处理流水线分为三个阶段：</p>
<ol>
<li><strong>构建检索块数据库</strong>：生成用于检索邻居与续写块的数据库，再交给检索编码器处理。</li>
<li><strong>构建相似度检索索引</strong>：训练并构建检索索引，用于查询块的邻居。</li>
<li><strong>查询预训练邻居</strong>：将预训练样本匹配到数据库块。训练、验证、测试集将分别生成邻居。</li>
</ol>
<p>下文将详细介绍流水线、代码结构、使用方式以及预训练流程。</p>
<!-- ################ contents ################ -->
<h1 id="_1">目录</h1>
<ul>
<li><a href="#快速开始">快速开始</a></li>
<li><a href="#教学示例">教学示例</a></li>
<li><a href="#代码结构">代码结构</a></li>
<li><a href="#命令行参数">命令行参数</a>
  <!-- * [Pretraining](#pretraining) -->
</li>
</ul>
<!-- ################ quick start ################ -->

<h1 id="_2">快速开始</h1>
<p>关键脚本：</p>
<ul>
<li><code>main.py</code>：预处理入口。</li>
<li><code>examples/preprocess_data.sh</code>：示例预处理脚本（调用 <code>main.py</code>）。</li>
<li><code>examples/pretrain_data.sh</code>：示例预训练脚本（调用 <code>pretrain_retro.py</code>）。</li>
</ul>
<p>通过 <code>--retro-tasks</code> 控制预处理阶段：</p>
<ul>
<li>最简流程（一次性全部完成）：<code>--retro-tasks build</code></li>
<li>如需按照资源调度分别运行：</li>
<li>构建检索数据库：<code>--retro-tasks db-build</code></li>
<li>构建检索索引：<code>--retro-tasks index-build</code></li>
<li>查询邻居：<code>--retro-tasks pretraining-query-neighbors</code></li>
</ul>
<p>执行流程概览：</p>
<ul>
<li><code>main.py</code>：入口（例如指定 <code>--retro-tasks X</code>）。</li>
<li><code>db/build.py</code>：构建检索数据库。</li>
<li><code>index/build.py</code>：构建检索索引，内部调用：</li>
<li><code>index/train.py</code>：在数据库子集上训练索引。</li>
<li><code>index/add.py</code>：将数据库块写入索引。</li>
<li><code>pretraining/query.py</code>：为预训练样本查询邻居（写入磁盘，供训练时加载）。</li>
</ul>
<!-- ################ tutorial ################ -->

<h1 id="_3">教学示例</h1>
<p>以下以维基百科语料为例，演示如何构建检索数据库与索引，并为预训练数据查询邻居。</p>
<h2 id="1">步骤 1：准备检索语料</h2>
<p>语料格式与 Megatron 训练数据一致。若需从 JSON 转换为 mmap 格式，请参考 <a href="../../../#data-preprocessing">数据预处理</a>。</p>
<p>假设维基语料存储如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&lt;retrieval/db/path&gt;/Wikipedia_shuf_text_document.bin
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>&lt;retrieval/db/path&gt;/Wikipedia_shuf_text_document.idx
</code></pre></div>
<p>检索库也可以由多种语料混合构成。</p>
<h2 id="2">步骤 2：构建检索块数据库</h2>
<p>该“数据库”实质上是一个二维数组（非关系型数据库），存储从 GPT Token 数据集中抽取的块（通常长度为 64）。每个文档会被切分为连续、不重叠的块；块的长度满足 1 &lt;= chunk_length &lt;= max_chunk_length（块不会跨文档）。<br />
在极少数情况下（约十万分之一），某些块会转换为空的 Bert 序列，我们会直接丢弃。因此实际块数略小于简单估算。</p>
<p>以维基语料为例，准备以下参数并在 <a href="examples/preprocess_data.sh">tools/retro/examples/preprocess_data.sh</a> 中修改模板：
- <code>--retro-workdir</code>：流水线保存数据与配置文件的目录。<strong>在整个流程及预训练阶段需保持一致。</strong>
- <code>--data-path</code>：用于构建检索数据库的语料路径，例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nv">WIK</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DATA_HOME</span><span class="si">}</span><span class="s2">/Wikipedia_shuf_text_document&quot;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nv">DATA_BLEND</span><span class="o">=</span><span class="s2">&quot; \</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="s2">  1 </span><span class="si">${</span><span class="nv">WIK</span><span class="si">}</span><span class="s2"> \</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="s2">&quot;</span>
</code></pre></div>
- <code>--load</code>：Bert 编码器权重路径
- <code>--vocab-file</code> 与 <code>--retro-bert-vocab-file</code>：Bert 词表
- <code>--retro-gpt-tokenizer-model</code>：GPT 分词器模型文件</p>
<p>执行脚本：
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>bash<span class="w"> </span>tools/retro/examples/preprocess_data.sh<span class="w"> </span>db-build
</code></pre></div></p>
<p>完成后输出包括：
- 启动参数写入 <code>&lt;retro-workdir&gt;/args.json</code>，供后续步骤使用。
- 检索块数据库保存在 <code>&lt;retro-workdir&gt;/db/</code>，数据集信息写入 <code>&lt;retro-workdir&gt;/db/indexed_dataset_infos.json</code>。</p>
<h2 id="3">步骤 3：构建相似度检索索引</h2>
<p>为了将预训练块匹配到数据库块，需要构建检索索引。我们使用 Faiss (https://github.com/facebookresearch/faiss)。索引通常在数据库子集上训练（通过 <code>--retro-index-ntrain</code> 指定），训练完成后将所有块写入索引以便查询。</p>
<p>当在后续步骤查询邻居时，需要确保索引能够被正确加载并匹配到数据库。有关索引参数可参考 Faiss 文档。</p>
<h2 id="4">步骤 4：查询预训练邻居</h2>
<p>为了加速训练，会提前为预训练数据（训练/验证/测试）生成邻居并存盘。具体步骤：
1. 遍历预训练数据，将每个样本划分为块；
2. 使用 Bert 将块编码；
3. 查询索引得到邻居并写入磁盘。</p>
<p>生成的邻居会携带数据集属性（如 seed、序列长度、样本数等），以保证预处理与训练配置对齐。</p>
<p>可以调节查询时的超参数以提升邻居质量，例如 <code>RETRO_QUERY_EF_SEARCH</code> 与 <code>RETRO_QUERY_NPROBE</code>。最重要的是 <code>RETRO_QUERY_NPROBE</code>，它决定了查询时搜索的聚类数量。建议参考 <a href="https://github.com/facebookresearch/faiss/wiki/Index-IO,-cloning-and-hyper-parameter-tuning">Faiss 调参指南</a>。</p>
<p>仍以维基语料为例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>bash<span class="w"> </span>tools/retro/examples/preprocess_data.sh<span class="w"> </span>query-pretraining-neighbors
</code></pre></div>
<p>输出包括：
- <code>&lt;retro-workdir&gt;/wiki/query/train_...</code>：训练集邻居。
- <code>&lt;retro-workdir&gt;/wiki/query/valid_...</code>：验证集邻居。</p>
<h2 id="5">步骤 5：可视化检索邻居</h2>
<p>我们提供 CLI 工具帮助确认检索质量。使用方法：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.retro.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">retro</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">retro</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s2">&quot;/path/to/retro/workdir&quot;</span><span class="p">)</span>
</code></pre></div>
<p>该命令会初始化 Megatron 并载入 Retro 数据，同时打印示例指令。</p>
<p>以下为维基语料的输出示例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>setting number of micro-batches to constant 32
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>&gt; building BertWordPieceLowerCase tokenizer ...
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>&gt; initializing torch distributed ...
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>&gt; initialized tensor model parallel with size 1
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>&gt; initialized pipeline model parallel with size 1
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>&gt; compiling dataset index builder ...
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>...
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>...
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a> &gt; sample ratios:
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>   dataset 0, input: 1, achieved: 1
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>&gt; size of blendable dataset: 201000 samples
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>&gt; elapsed time for building blendable dataset indices: 0.00 (sec)
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>&gt; building indices for blendable datasets ...
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a> &gt; sample ratios:
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>   dataset 0, input: 1, achieved: 1
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>&gt; size of blendable dataset: 12864 samples
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>&gt; finished creating pretrained GPT datasets ...
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>++++++++++++++++++++++++++++++++++++++++++++++++++
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>examples ... [ *note*: &#39;db&#39; = chunk db; &#39;pt&#39; = pretraining corpus. ]
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>++++++++++++++++++++++++++++++++++++++++++++++++++
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>~~~~ indexed datasets ~~~~
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>retro.get_db_num_indexed_datasets() : 1
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>retro.get_db_indexed_dataset_infos() :
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>  [(1.000000, Wikipedia_shuf_text_document)]
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>~~~~ counts ~~~~
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>retro.get_db_num_chunks : 68104992.
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>retro.get_pt_num_samples(&#39;train&#39;) : 201000.
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>retro.get_pt_num_samples(&#39;valid&#39;) : 12864.
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>retro.get_pt_num_chunks(&#39;train&#39;) : 1608000.
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>retro.get_pt_num_chunks(&#39;valid&#39;) : 102912.
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>~~~~ tokens, text ~~~~
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>retro.get_db_chunk_gpt(chunk_id) : [46809, 218340, 716, 647, ... , 251525, 872, 692, 4042]
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>retro.get_db_chunk_bert(chunk_id) : [10680, 16216, 4313, 1745 ... , 8117, 1007, 1012, 1997]
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>retro.get_db_chunk_text(chunk_id) 等函数可以直接查看块的原始文本及续写。`retro.get_pt_sample` 支持读取预训练样本及其邻居，便于检查形状与示例内容。
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>也可使用 `retro.print_neighbor_texts(sample_id, chunk_id)` 快速查看某个样本的邻居文本。例如：
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>```python
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>tokens = retro.get_pt_sample(&#39;train&#39;, 0)
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>for token_ids in tokens[&quot;neighbor_tokens&quot;][0]:
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>    print(&quot;- %s&quot; % (retro.gpt_to_text(token_ids)))
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>    print(&quot;-&quot; * 20)
</code></pre></div>
<p>输出示例（截取部分）：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>PRETRAINING CHUNK:
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>  - also\nLatgalians (modern)\n\nReferences\n\nCategory:Defunct political parti ...
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>NEIGHBOR_CHUNKS:
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  - the sides.\n\nNotes\n\nReferences\n\nCategory:Obaku Zen\n*\nCategory:Japane ...
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>  - 2007).\n\nSee also\n Satellite Communications\n Tonga\n\nReferences\n\nExte ...
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>  - ...
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>上述示例也可以通过直接调用 `retro.get_pt_sample` 实现，并便于检查返回张量的形状：
</code></pre></div>
sample = retro.get_pt_sample('train', sample_id)</p>
<p>sample['text'].shape : (513,)
sample['neighbor_tokens'].shape : (8, 20, 128)
sample['text'] : [   676     14  40656 184 ... 4\n    276  17361 251542]
sample['neighbor_tokens'][17][1] : [    14     14  30291   1 ... 682    328    379 251527]
retro.gpt_to_text(sample['text']) : also\nLatgalians (modern) ... ission criticised the AVN
retro.gpt_to_text(sample['neighbor_tokens']) : \n\nHis second marriage o ... Augusta Eardley-Wilmot (2
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>### 输入与输出数据
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>输入数据：
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>- 通过 `gpt_dataset.py` 加载的 Token 数据集。
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>- **`&lt;RETRO_WORKDIR&gt;/index/&lt;RETRO_INDEX_TYPE&gt;/&lt;RETRO_INDEX_STR&gt;/added.faissindex`**：已经训练并写入全部数据库块的索引（详见前文）。
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>输出数据：
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>- **`&lt;RETRO_WORKDIR&gt;/{train,valid,test}_XXns_YYsl_ZZs/WW.hdf5`**：这些目录/文件保存预训练样本各块的邻居索引。例如 `train_indexmap_2047435ns_2048sl_1234s` 目录中包含一组 HDF5 文件（如 `0075700000-0075800000.hdf5`），每个文件覆盖一段连续的邻居 ID，用于索引主检索数据库。某个目录下的所有 HDF5 文件共同构成对应数据集的全部邻居信息。文件大小由 `--retro-block-size` 控制。命名中的 `XX`、`YY`、`ZZ`、`WW` 用于标记数据集属性，以保证在预训练阶段与配置保持一致。这些邻居文件最终由 `retro_dataset.py` 加载，构建 Retro 训练样本。
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>### `tools/retro/cli`
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>提供了检查预处理数据的 CLI。进入 Python 交互式环境后，可通过以下命令加载 Retro 工作目录：
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>```python
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>from tools.retro.cli import retro
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>retro.init(&quot;/path/to/retro/workdir&quot;)
</code></pre></div></p>
<p>该命令会初始化 Megatron 并准备好 Retro 数据，同时输出可用函数的帮助信息。CLI 中包含多种查看检索数据库以及预训练样本/邻居的工具，例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">retro</span><span class="o">.</span><span class="n">get_db_num_indexed_datasets</span><span class="p">()</span> <span class="c1"># 15</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">retro</span><span class="o">.</span><span class="n">get_db_chunk_text</span><span class="p">(</span><span class="mi">92874113</span><span class="p">)</span> <span class="c1"># &#39;research project at ...  and philosophy&#39;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">retro</span><span class="o">.</span><span class="n">get_pt_sample</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="mi">62005</span><span class="p">)</span> <span class="c1"># &#39;[16084, 26158, 25387 ..., 6898, 9568]&#39;</span>
</code></pre></div>
<p>函数名前缀通常用于指示所查看的数据：</p>
<ul>
<li><strong><code>db</code></strong>：检索数据库（块 token、文档 ID、数据集 ID 等）</li>
<li><strong><code>pt</code></strong>：预训练数据集（样本 token 与邻居 token 等）</li>
</ul>
<h3 id="toolsretroutilspy"><code>tools/retro/utils.py</code></h3>
<p>封装常用工具函数，主要包括：</p>
<ul>
<li><strong><code>get_gpt_tokenizer()</code></strong>：获取 GPT 分词器。</li>
<li><strong><code>get_bert_tokenizer()</code></strong>：获取 Bert 分词器。</li>
<li><strong><code>GPTToTextDataset</code></strong>：将 GPT（BPE）样本转换为原始文本的封装类。</li>
</ul>
<h3 id="toolsbert_embedding"><code>tools/bert_embedding</code></h3>
<p>用于生成 Bert 嵌入。关键文件如下：</p>
<ul>
<li><strong><code>embed.py</code></strong>：嵌入生成入口，包含核心类 <code>BertEmbedder</code> 与 <code>DiskDataParallelBertEmbedder</code>（详见下文），实现 Megatron 风格的嵌入逻辑。</li>
<li><strong><code>huggingface.py</code></strong>：当配置输出 Hugging Face 嵌入时由 <code>embed.py</code> 调用。</li>
<li><strong><code>dataset.py</code></strong>：将原始文本数据集转换为 Bert（WordPiece）序列的封装类。</li>
</ul>
<p>嵌入生成可从两个维度配置。第一，输出形式：</p>
<ul>
<li><strong><code>BertEmbedder</code></strong>：输入原始文本数据集，输出 Numpy 数组。核心方法包括 <code>embed_text_dataset</code>（处理整个数据集）与 <code>embed_text</code>（处理单个字符串）。</li>
<li><strong><code>DiskDataParallelBertEmbedder</code></strong>：对 <code>BertEmbedder</code> 的封装，结果写入磁盘。它会自动在数据并行 rank 之间分配数据，并按指定 <code>block_size</code>（如 1,000,000）分块处理。</li>
</ul>
<p>第二，嵌入模型类型，由 <code>--bert-embedder-type</code> 控制：</p>
<ul>
<li><strong><code>--bert-embedder-type megatron</code></strong>：使用 Megatron 的 Bert 模型，具体权重、词表和分词器取决于加载的检查点。</li>
<li><strong><code>--bert-embedder-type huggingface</code></strong>：使用 Hugging Face 的 <code>bert-large-cased</code>。（<em>注意</em>：该选项后续可能弃用，目前也无法调整大小写配置。）</li>
</ul>
<h3 id="_4">预训练</h3>
<ul>
<li><strong><code>pretrain_retro.py</code></strong>：Retro 预训练入口，类似 <code>pretrain_gpt.py</code>，但负责加载邻居 token 并设置邻居注意力掩码。</li>
<li><strong><code>megatron/model/retro_transformer.py</code></strong>：Retro 模型实现，包含主 Transformer、检索编码器与分块交叉注意力层。当前文件中仍保留与 <code>transformer.py</code> 基本一致的多个类，后续会合并差异。</li>
<li><strong><code>tools/retro/pretraining/retro_dataset.py</code></strong>：预训练阶段使用的 Retro 数据集（预处理阶段未用）。每个样本包含自身 token 以及每个块对应的邻居 token。</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>